#!/bin/bash
set -ex -o pipefail

bin_dir=$(dirname "${BASH_SOURCE[0]}")
CONCOURSE_DIR="$(cd "$bin_dir/.."; pwd)"

print_usage(){
  echo "Usage: $0 <bosh_deployment> <iaas>"
}

BOSH_DEPLOYMENT="$1"
IAAS="$2"

if [ -z "$BOSH_DEPLOYMENT" ]; then
  print_usage
  exit 1
fi

if [ -z "$IAAS" ]; then
  print_usage
  exit 1
fi

set -u

BOSH_DEPLOYMENT=$(cd "$BOSH_DEPLOYMENT"; pwd)
director_yml="$CONCOURSE_DIR/$IAAS/director.yml"

secrets_lpass_note_id=$(bosh-cli int "${director_yml}" --path='/private_note_id')

manifest_file=$(mktemp)

secret=$(lpass show --note "$secrets_lpass_note_id")

if bosh-cli int "${director_yml}" --path='/secrets_lpass_note_path'; then
  secrets_lpass_note_path=$(bosh-cli int "${director_yml}" --path='/secrets_lpass_note_path')
  secret=$(echo -n "$secret" | bosh int - --path="/$secrets_lpass_note_path")
fi
echo "$secret"

if [ "$IAAS" == "vsphere" ]; then
  bosh-cli interpolate "$BOSH_DEPLOYMENT/bosh.yml"  \
    --ops-file "$BOSH_DEPLOYMENT/$IAAS/cpi.yml" \
    --ops-file "$BOSH_DEPLOYMENT/vsphere/resource-pool.yml" \
    --vars-file "${director_yml}" \
    --vars-file <(echo -n "$secret") \
    > "$manifest_file"
elif [ "$IAAS" == "openstack" ]; then
  bosh-cli interpolate "$BOSH_DEPLOYMENT/bosh.yml"  \
    --ops-file "$BOSH_DEPLOYMENT/$IAAS/cpi.yml" \
    --ops-file "$CONCOURSE_DIR/$IAAS/nova.yml" \
    --vars-file "${director_yml}" \
    --vars-file <(echo -n "$secret") \
    > "$manifest_file"
elif [[ "${IAAS}" == "gcp" ]]; then
  # Main concourse director
  echo "+==========+"
  echo "| WARNING! |"
  echo "+==========+"
  echo ""
  echo "Credhub version is overridden to install 1.6.1"
  echo "Please remove the override once bosh-deployment"
  echo "is updated to install a newer version"
  echo ""

  gcp_credentials_note_id="$(bosh-cli int "${director_yml}" --path='/service_account_lpass_note_id')"
  gcp_credentials="$(lpass show --note ${gcp_credentials_note_id})"

  bosh-cli interpolate "$BOSH_DEPLOYMENT/bosh.yml"  \
    --ops-file "$BOSH_DEPLOYMENT/$IAAS/cpi.yml" \
    --ops-file "$BOSH_DEPLOYMENT/uaa.yml" \
    --ops-file "$BOSH_DEPLOYMENT/credhub.yml" \
    --ops-file "$CONCOURSE_DIR/$IAAS/credhub-161.yml" \
    --vars-file "${director_yml}" \
    --var-file gcp_credentials_json=<(echo -n ${gcp_credentials}) \
    --vars-file <(echo -n "$secret") \
    > "$manifest_file"
else
  bosh-cli interpolate "$BOSH_DEPLOYMENT/bosh.yml"  \
    --ops-file "$BOSH_DEPLOYMENT/$IAAS/cpi.yml" \
    --vars-file "${director_yml}" \
    --vars-file <(echo -n "$secret") \
    > "$manifest_file"
fi

bosh-cli create-env "$manifest_file" \
    --vars-store "$CONCOURSE_DIR/$IAAS/private.yml" \
    --state "$CONCOURSE_DIR/$IAAS/state.json"

